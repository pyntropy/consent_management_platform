# Получить наборы атрибутов клиента для заполнения согласий

## Описание сценария

| Параметр        | Значение                                                           |
|:----------------|:-------------------------------------------------------------------|
| Название:       | Получить наборы атрибутов клиента для заполенния согласий.         |
| Цель:           | Получить наборы атрибутов клиента для заполенния согласий.         |
| Предусловие:    | В канале произошло событие .                                       |
| Триггер:        | В канале сбора согласий возникла необходимость подписать согласия. |
| Инициатор:      | Канал сбора согласий (ЛК, 1С:УСК).                                 |
| Последствия:    |                                                                    |
| Бизнес правила: |                                                                    |

## Диаграмма

```mermaid
sequenceDiagram
    participant c as Канал сбора согласий
    participant cpm as СМР
    participant db as СМР БД
    c ->> cpm: 1. Получить сборку по атрибутам<br/>GET /bundles/by-attrs
    note left of cpm: {"product_id": "1", "self": false, kid: false}
    cpm ->> db: 2. Поиск сборки в таблице bundle_attrs
    alt Сборка найдена
        db -->> cpm: 3. id сборки, наборы атрибутов: attr-sets
        cpm -->> c: 4. 200 OK<br/>id сборки, наборы атрибутов

    else Сборка НЕ найдена
        db -->> cpm: 3a. Сборка по указанным атрибутам не найдена
        cpm -->> c: 3a.1 404 Not Found
    end
```

## Основной поток:

**Триггер:** Канал в параметрах полиса определил признак необходимости сбора согласия.

(1) Канал вызывает в СМР метод `GET /bundles/by-attrs&=<attr 1>=<value 1>&`

(2) СМР выбирает в таблице `bundle_attrs` сборку у которой набор атрибутов
полностью совпадет с набором переданным в запросе.

(3) СМР БД возвращает id сборки. **EXT**

(4) Канал получает список наборов атрибутов `attr_sets`
необходимых для подписания всех согласий в сборке.</p>

### Расширения

(3a) По указанным в запросе атрибутам сборка НЕ найдена

(3а.1) CPM возвращает 404 Not Found